<?xml version="1.0" encoding="UTF-8"?>
<proxy xmlns="http://ws.apache.org/ns/synapse"
       name="medium_getAccessToken"
       startOnLoad="true"
       statistics="disable"
       trace="disable"
       transports="http,https">
    <target>
        <inSequence>
            <property expression="json-eval($.access_token)"
                      name="access_token"
                      scope="default"
                      type="STRING"/>
            <property expression="json-eval($.authorId)"
                      name="uri.var.authorid"
                      scope="default"
                      type="STRING"/>
            <header name="Accept" scope="transport" value="utf-8"/>
            <header name="Accept-Charset" scope="transport" value="utf-8"/>
            <header name="Content-Type" scope="transport" value="application/json"/>
            <header expression="fn:concat('Bearer ', get-property('access_token'))"
                    name="Authorization"
                    scope="transport"/>
            <property expression="json-eval($.title)" name="title"/>
            <property expression="json-eval($.contentFormat)" name="contentFormat"/>
            <property expression="json-eval($.content)" name="content"/>
            <property expression="json-eval($.canonicalUrl)" name="canonicalUrl"/>
            <property expression="json-eval($.tags)" name="tags"/>
            <property expression="json-eval($.publishStatus)" name="publishStatus"/>
            <log level="full"/>
            <payloadFactory media-type="json">
                <format>{"title": "$1","contentFormat": "$2","content": "$3","canonicalUrl": "$4","tags":
                    $5,"publishStatus": "$6"}
                </format>
                <args>
                    <arg evaluator="xml" expression="get-property('title')"/>
                    <arg evaluator="xml" expression="get-property('contentFormat')"/>
                    <arg evaluator="xml" expression="get-property('content')"/>
                    <arg evaluator="xml" expression="get-property('canonicalUrl')"/>
                    <arg evaluator="xml" expression="get-property('tags')"/>
                    <arg evaluator="xml" expression="get-property('publishStatus')"/>
                </args>
            </payloadFactory>
            <call>
                <endpoint>
                    <http method="POST"
                          uri-template="https://api.medium.com/v1/users/{uri.var.authorid}/posts"/>
                </endpoint>
            </call>
            <respond/>
        </inSequence>
        <outSequence>
            <log/>
            <send/>
        </outSequence>
    </target>
    <description/>
</proxy>
